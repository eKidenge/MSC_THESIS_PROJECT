{% extends "core/base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid px-0">
    <!-- University Research Header -->
    <div class="bg-university text-white py-3">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-2 text-center">
                    <div class="research-logo">
                        <i class="fas fa-map-marked-alt fa-2x"></i>
                    </div>
                </div>
                <div class="col-md-8 text-center">
                    <h3 class="mb-1">EGERTON UNIVERSITY - SCENARIO DESIGN LAB</h3>
                    <p class="mb-0 opacity-75">Department of Computer Science | Traffic Simulation Scenario Creation</p>
                </div>
                <div class="col-md-2 text-center">
                    <div class="student-logo">
                        <i class="fas fa-traffic-light fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Research Navigation -->
    <div class="bg-dark text-white py-3">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-0"><i class="fas fa-drafting-compass"></i> CREATE TRAFFIC SCENARIO</h4>
                    <small class="opacity-75">Design custom traffic conditions for AI optimization research</small>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group" role="group">
                        <a href="{% url 'dashboard' %}" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                        <a href="{% url 'scenario_list' %}" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-list"></i> All Scenarios
                        </a>
                        <a href="{% url 'experiment_list' %}" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-flask"></i> Experiments
                        </a>
                        <a href="{% url 'results_list' %}" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-chart-bar"></i> Results
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container py-4">
        <!-- Display messages -->
        {% if messages %}
        <div class="messages mb-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="row">
            <!-- Scenario Creation Form -->
            <div class="col-lg-8">
                <div class="card scenario-creation-card mb-4">
                    <div class="card-header bg-gradient-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="mb-0"><i class="fas fa-plus-circle"></i> NEW TRAFFIC SCENARIO</h3>
                                <small class="opacity-75">Researcher: {% if user.is_authenticated %}{{ user.get_full_name|default:user.username }}{% else %}Guest Researcher{% endif %}</small>
                            </div>
                            <div class="scenario-badge">
                                <i class="fas fa-drafting-compass"></i> DESIGN MODE
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <form method="post" id="scenarioForm" action="{% url 'create_scenario' %}">
                            {% csrf_token %}
                            
                            <!-- Display form errors -->
                            {% if form.errors %}
                            <div class="alert alert-danger">
                                <strong>Please correct the errors below:</strong>
                                <ul class="mb-0">
                                    {% for field, errors in form.errors.items %}
                                        {% for error in errors %}
                                            <li>{{ field|title }}: {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            
                            <!-- Basic Information -->
                            <div class="form-section mb-4">
                                <h5 class="section-title">
                                    <i class="fas fa-info-circle text-primary"></i> BASIC INFORMATION
                                </h5>
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Scenario Name *</label>
                                            <input type="text" name="name" class="form-control form-control-lg" 
                                                   placeholder="e.g., Nairobi CBD Morning Peak Hour" 
                                                   value="{{ form.name.value|default:'' }}" required>
                                            {% if form.name.errors %}
                                            <div class="text-danger small">{{ form.name.errors }}</div>
                                            {% endif %}
                                            <small class="form-text text-muted">Give a descriptive name for your traffic scenario</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Research Priority</label>
                                            <select class="form-select" id="researchPriority" onchange="updateParameters()">
                                                <option value="high">High Priority</option>
                                                <option value="medium" selected>Medium Priority</option>
                                                <option value="low">Low Priority</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Location & Type -->
                            <div class="form-section mb-4">
                                <h5 class="section-title">
                                    <i class="fas fa-map-marker-alt text-success"></i> LOCATION & TYPE
                                </h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Scenario Type *</label>
                                            <select name="scenario_type" class="form-select scenario-type-select" required>
                                                <option value="">Select scenario type...</option>
                                                <option value="nairobi_peak">Nairobi Peak Hour</option>
                                                <option value="nakuru_central">Nakuru Central</option>
                                                <option value="mombasa_coastal">Mombasa Coastal</option>
                                                <option value="kisumu_lakeside">Kisumu Lakeside</option>
                                            </select>
                                            {% if form.scenario_type.errors %}
                                            <div class="text-danger small">{{ form.scenario_type.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Time Period</label>
                                            <select class="form-select" id="timePeriod" onchange="updateParameters()">
                                                <option value="peak">Peak Hours (7-9 AM, 5-7 PM)</option>
                                                <option value="off_peak">Off-Peak Hours</option>
                                                <option value="night">Night Time</option>
                                                <option value="weekend">Weekend</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Description -->
                            <div class="form-section mb-4">
                                <h5 class="section-title">
                                    <i class="fas fa-file-alt text-warning"></i> SCENARIO DESCRIPTION
                                </h5>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Research Description</label>
                                    <textarea name="description" class="form-control" rows="4" 
                                              placeholder="Describe the traffic conditions, special considerations, and research objectives for this scenario...">{{ form.description.value|default:'' }}</textarea>
                                    {% if form.description.errors %}
                                    <div class="text-danger small">{{ form.description.errors }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">This description will be used in research papers and reports</small>
                                </div>
                            </div>
                            
                            <!-- Simulation Parameters -->
                            <div class="form-section mb-4">
                                <h5 class="section-title">
                                    <i class="fas fa-sliders-h text-danger"></i> SIMULATION PARAMETERS
                                </h5>
                                
                                <div class="parameters-guide mb-3">
                                    <div class="alert alert-info">
                                        <i class="fas fa-lightbulb"></i> 
                                        <strong>Research Tip:</strong> Adjust these parameters to create realistic traffic conditions for AI testing
                                    </div>
                                </div>
                                
                                <!-- Quick Parameters -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="parameter-quick">
                                            <label class="form-label fw-bold">Duration</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="durationInput" value="3600" min="300" max="86400" onchange="updateJSON()">
                                                <span class="input-group-text">seconds</span>
                                            </div>
                                            <small class="form-text text-muted">Simulation length</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="parameter-quick">
                                            <label class="form-label fw-bold">Vehicle Count</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="vehicleCountInput" value="1000" min="10" max="10000" onchange="updateJSON()">
                                                <span class="input-group-text">vehicles</span>
                                            </div>
                                            <small class="form-text text-muted">Total vehicles</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="parameter-quick">
                                            <label class="form-label fw-bold">Intersections</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="intersectionsInput" value="20" min="1" max="200" onchange="updateJSON()">
                                                <span class="input-group-text">nodes</span>
                                            </div>
                                            <small class="form-text text-muted">Traffic nodes</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="parameter-quick">
                                            <label class="form-label fw-bold">Peak Hour</label>
                                            <div class="form-check form-switch mt-2">
                                                <input class="form-check-input" type="checkbox" id="peakHourSwitch" checked onchange="updateJSON()">
                                                <label class="form-check-label" for="peakHourSwitch">Enabled</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- JSON Parameters -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Advanced Parameters (JSON)</label>
                                    <div class="json-editor">
                                        <textarea name="parameters" class="form-control json-textarea" rows="8" 
                                                  id="parametersInput" required>{{ form.parameters.value|default:'{"duration": 3600, "vehicle_count": 1000, "intersections": 20, "peak_hour": true, "weather": "clear", "accident_rate": 0.01, "traffic_density": "medium", "visibility": "good", "road_condition": "good"}' }}</textarea>
                                        {% if form.parameters.errors %}
                                        <div class="text-danger small">{{ form.parameters.errors }}</div>
                                        {% endif %}
                                        <div class="json-tools mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-info" onclick="formatJSON()">
                                                <i class="fas fa-code"></i> Format JSON
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-success" onclick="updateFromQuick()">
                                                <i class="fas fa-sync-alt"></i> Update from Quick Settings
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-warning" onclick="validateJSON()">
                                                <i class="fas fa-check-circle"></i> Validate
                                            </button>
                                        </div>
                                    </div>
                                    <small class="form-text text-muted">Advanced researchers can edit JSON directly for precise control</small>
                                </div>
                            </div>
                            
                            <!-- Status & Submit -->
                            <div class="form-section">
                                <h5 class="section-title">
                                    <i class="fas fa-cog text-secondary"></i> FINAL SETTINGS
                                </h5>
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" name="is_active" class="form-check-input" id="activeSwitch" checked>
                                            <label class="form-check-label fw-bold" for="activeSwitch">
                                                <i class="fas fa-toggle-on"></i> Active Scenario
                                            </label>
                                            <small class="d-block text-muted">Active scenarios are available for immediate simulation</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'scenario_list' %}" class="btn btn-secondary btn-lg">
                                                <i class="fas fa-times"></i> Cancel
                                            </a>
                                            <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                                <i class="fas fa-save"></i> CREATE SCENARIO
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar: Guidelines & Examples -->
            <div class="col-lg-4">
                <!-- Research Guidelines -->
                <div class="card guidelines-card mb-4">
                    <div class="card-header bg-gradient-success text-white">
                        <h5 class="mb-0"><i class="fas fa-book-open"></i> RESEARCH GUIDELINES</h5>
                    </div>
                    <div class="card-body">
                        <div class="guideline-item mb-3">
                            <div class="guideline-icon">
                                <i class="fas fa-lightbulb text-warning"></i>
                            </div>
                            <div class="guideline-content">
                                <h6>Realistic Parameters</h6>
                                <p class="small mb-0">Base your parameters on real traffic data from Kenyan cities for authentic results.</p>
                            </div>
                        </div>
                        
                        <div class="guideline-item mb-3">
                            <div class="guideline-icon">
                                <i class="fas fa-chart-line text-primary"></i>
                            </div>
                            <div class="guideline-content">
                                <h6>Comparative Studies</h6>
                                <p class="small mb-0">Create multiple scenarios to compare AI performance across different conditions.</p>
                            </div>
                        </div>
                        
                        <div class="guideline-item mb-3">
                            <div class="guideline-icon">
                                <i class="fas fa-file-alt text-info"></i>
                            </div>
                            <div class="guideline-content">
                                <h6>Documentation</h6>
                                <p class="small mb-0">Detailed descriptions help in thesis writing and research paper preparation.</p>
                            </div>
                        </div>
                        
                        <div class="guideline-item">
                            <div class="guideline-icon">
                                <i class="fas fa-flask text-danger"></i>
                            </div>
                            <div class="guideline-content">
                                <h6>Experimental Design</h6>
                                <p class="small mb-0">Design scenarios that test specific aspects of your AI algorithms.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Example Scenarios -->
                <div class="card examples-card mb-4">
                    <div class="card-header bg-gradient-info text-white">
                        <h5 class="mb-0"><i class="fas fa-clipboard-list"></i> EXAMPLE SCENARIOS</h5>
                    </div>
                    <div class="card-body">
                        <div class="example-scenario mb-3">
                            <h6 class="text-success">Nairobi CBD Peak Hour</h6>
                            <pre class="small bg-light p-2 mb-2 json-example">{
  "duration": 7200,
  "vehicle_count": 1500,
  "intersections": 25,
  "peak_hour": true,
  "weather": "clear",
  "accident_rate": 0.015,
  "traffic_density": "high"
}</pre>
                            <small class="text-muted">High density, morning rush hour simulation</small>
                            <button class="btn btn-sm btn-outline-success w-100 mt-2" onclick="loadExample('nairobi')">
                                <i class="fas fa-arrow-down"></i> Load This Example
                            </button>
                        </div>
                        
                        <div class="example-scenario mb-3">
                            <h6 class="text-primary">Mombasa Coastal Weekend</h6>
                            <pre class="small bg-light p-2 mb-2 json-example">{
  "duration": 10800,
  "vehicle_count": 800,
  "intersections": 15,
  "peak_hour": false,
  "weather": "sunny",
  "tourist_ratio": 0.4,
  "traffic_flow": "moderate"
}</pre>
                            <small class="text-muted">Mixed tourist and local traffic</small>
                            <button class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="loadExample('coastal')">
                                <i class="fas fa-arrow-down"></i> Load This Example
                            </button>
                        </div>
                        
                        <div class="example-scenario">
                            <h6 class="text-warning">Nakuru Rainy Day</h6>
                            <pre class="small bg-light p-2 mb-2 json-example">{
  "duration": 5400,
  "vehicle_count": 600,
  "intersections": 18,
  "peak_hour": true,
  "weather": "rain",
  "accident_rate": 0.02,
  "visibility": "low"
}</pre>
                            <small class="text-muted">Adverse weather conditions testing</small>
                            <button class="btn btn-sm btn-outline-warning w-100 mt-2" onclick="loadExample('rainy')">
                                <i class="fas fa-arrow-down"></i> Load This Example
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="card actions-card">
                    <div class="card-header bg-gradient-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-bolt"></i> QUICK ACTIONS</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="loadTemplate('nairobi')">
                                <i class="fas fa-city"></i> Load Nairobi Template
                            </button>
                            <button class="btn btn-outline-success" onclick="loadTemplate('coastal')">
                                <i class="fas fa-umbrella-beach"></i> Load Coastal Template
                            </button>
                            <button class="btn btn-outline-info" onclick="loadTemplate('rainy')">
                                <i class="fas fa-cloud-rain"></i> Load Rainy Day Template
                            </button>
                            <a href="{% url 'scenario_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-eye"></i> View Existing Scenarios
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Research Footer -->
    <footer class="bg-research-footer text-white py-4 mt-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5><i class="fas fa-university"></i> EGERTON UNIVERSITY</h5>
                    <p class="small">Faculty of Science<br>Department of Computer Science<br>Nakuru, Kenya</p>
                </div>
                <div class="col-md-4 text-center">
                    <h5><i class="fas fa-user-graduate"></i> RESEARCHER</h5>
                    <p class="small mb-1"><strong>Elisha Kidenge</strong></p>
                    <p class="small mb-1">SM24/11854/24</p>
                    <p class="small mb-1">MSc Computer Science</p>
                    <p class="small">Traffic Simulation Research</p>
                </div>
                <div class="col-md-4 text-end">
                    <h5><i class="fas fa-chalkboard-teacher"></i> SUPERVISION</h5>
                    <p class="small mb-1"><strong>Dr. Zachary Bosire</strong> (Lead Supervisor)</p>
                    <p class="small mb-1"><strong>Dr. Duke Oeba</strong> (Co-Supervisor)</p>
                    <p class="small">AI & Urban Planning Research Unit</p>
                </div>
            </div>
            <hr class="bg-light my-3">
            <div class="text-center">
                <p class="mb-0 small">
                    <i class="fas fa-graduation-cap"></i> 
                    Â© 2024 Egerton University - MSc Computer Science Thesis | 
                    Scenario Design Module
                </p>
            </div>
        </div>
    </footer>
</div>

<script>
    // Initialize default JSON parameters
    document.addEventListener('DOMContentLoaded', function() {
        const jsonTextarea = document.getElementById('parametersInput');
        if (!jsonTextarea.value || jsonTextarea.value.trim() === '') {
            // Set default parameters
            const defaultParams = {
                duration: 3600,
                vehicle_count: 1000,
                intersections: 20,
                peak_hour: true,
                weather: "clear",
                accident_rate: 0.01,
                traffic_density: "medium",
                visibility: "good",
                road_condition: "good"
            };
            jsonTextarea.value = JSON.stringify(defaultParams, null, 2);
        }
        
        // Initialize quick controls from JSON
        initializeQuickControls();
    });

    // Initialize quick controls from JSON
    function initializeQuickControls() {
        const jsonTextarea = document.getElementById('parametersInput');
        try {
            const params = JSON.parse(jsonTextarea.value);
            
            if (params.duration) {
                document.getElementById('durationInput').value = params.duration;
            }
            if (params.vehicle_count) {
                document.getElementById('vehicleCountInput').value = params.vehicle_count;
            }
            if (params.intersections) {
                document.getElementById('intersectionsInput').value = params.intersections;
            }
            if (params.peak_hour !== undefined) {
                document.getElementById('peakHourSwitch').checked = params.peak_hour;
            }
        } catch (e) {
            console.error('Error initializing quick controls:', e);
        }
    }

    // Update JSON from quick controls
    function updateJSON() {
        const params = {
            duration: parseInt(document.getElementById('durationInput').value) || 3600,
            vehicle_count: parseInt(document.getElementById('vehicleCountInput').value) || 1000,
            intersections: parseInt(document.getElementById('intersectionsInput').value) || 20,
            peak_hour: document.getElementById('peakHourSwitch').checked,
            weather: getWeatherFromScenario(),
            accident_rate: getAccidentRate(),
            traffic_density: getTrafficDensity(),
            visibility: getVisibility(),
            road_condition: "good",
            timestamp: new Date().toISOString()
        };
        
        const jsonTextarea = document.getElementById('parametersInput');
        jsonTextarea.value = JSON.stringify(params, null, 2);
    }

    // Update parameters based on form selections
    function updateParameters() {
        const priority = document.getElementById('researchPriority').value;
        const timePeriod = document.getElementById('timePeriod').value;
        const scenarioType = document.querySelector('select[name="scenario_type"]').value;
        
        // Adjust parameters based on selections
        let duration = 3600;
        let vehicleCount = 1000;
        let intersections = 20;
        let peakHour = true;
        
        switch(timePeriod) {
            case 'peak':
                duration = 7200;
                vehicleCount = 1500;
                peakHour = true;
                break;
            case 'off_peak':
                duration = 5400;
                vehicleCount = 600;
                peakHour = false;
                break;
            case 'night':
                duration = 10800;
                vehicleCount = 300;
                peakHour = false;
                break;
            case 'weekend':
                duration = 14400;
                vehicleCount = 1200;
                peakHour = false;
                break;
        }
        
        switch(scenarioType) {
            case 'nairobi_peak':
                intersections = 25;
                vehicleCount = Math.max(vehicleCount, 1500);
                break;
            case 'nakuru_central':
                intersections = 18;
                vehicleCount = Math.max(vehicleCount, 800);
                break;
            case 'mombasa_coastal':
                intersections = 15;
                vehicleCount = Math.max(vehicleCount, 600);
                break;
            case 'kisumu_lakeside':
                intersections = 20;
                vehicleCount = Math.max(vehicleCount, 700);
                break;
        }
        
        if (priority === 'high') {
            duration = Math.min(duration * 1.5, 86400);
            vehicleCount = Math.min(vehicleCount * 1.2, 10000);
        } else if (priority === 'low') {
            duration = Math.max(duration * 0.7, 600);
            vehicleCount = Math.max(vehicleCount * 0.8, 10);
        }
        
        // Update quick controls
        document.getElementById('durationInput').value = duration;
        document.getElementById('vehicleCountInput').value = vehicleCount;
        document.getElementById('intersectionsInput').value = intersections;
        document.getElementById('peakHourSwitch').checked = peakHour;
        
        // Update JSON
        updateJSON();
    }

    // Helper functions for parameter generation
    function getWeatherFromScenario() {
        const scenarioType = document.querySelector('select[name="scenario_type"]').value;
        const timePeriod = document.getElementById('timePeriod').value;
        
        if (timePeriod === 'rain' || scenarioType.includes('rain')) {
            return 'rain';
        } else if (scenarioType === 'mombasa_coastal') {
            return 'sunny';
        } else {
            return 'clear';
        }
    }

    function getAccidentRate() {
        const priority = document.getElementById('researchPriority').value;
        const timePeriod = document.getElementById('timePeriod').value;
        
        let rate = 0.01;
        
        if (timePeriod === 'peak') rate = 0.015;
        if (timePeriod === 'night') rate = 0.02;
        if (getWeatherFromScenario() === 'rain') rate = 0.025;
        
        if (priority === 'high') rate *= 1.5;
        if (priority === 'low') rate *= 0.5;
        
        return Math.min(rate, 0.05);
    }

    function getTrafficDensity() {
        const vehicleCount = parseInt(document.getElementById('vehicleCountInput').value) || 1000;
        
        if (vehicleCount > 1200) return 'high';
        if (vehicleCount > 800) return 'medium_high';
        if (vehicleCount > 400) return 'medium';
        return 'low';
    }

    function getVisibility() {
        const weather = getWeatherFromScenario();
        const timePeriod = document.getElementById('timePeriod').value;
        
        if (weather === 'rain') return 'low';
        if (timePeriod === 'night') return 'medium';
        return 'good';
    }

    // JSON formatting and validation
    function formatJSON() {
        const textarea = document.getElementById('parametersInput');
        try {
            const obj = JSON.parse(textarea.value);
            textarea.value = JSON.stringify(obj, null, 2);
            showAlert('JSON formatted successfully!', 'success');
        } catch (e) {
            showAlert('Invalid JSON format: ' + e.message, 'danger');
        }
    }
    
    function validateJSON() {
        const textarea = document.getElementById('parametersInput');
        try {
            JSON.parse(textarea.value);
            showAlert('JSON is valid!', 'success');
            return true;
        } catch (e) {
            showAlert('Invalid JSON: ' + e.message, 'danger');
            return false;
        }
    }
    
    function updateFromQuick() {
        updateJSON();
        showAlert('Parameters updated from quick settings!', 'info');
    }
    
    function loadTemplate(template) {
        const templates = {
            nairobi: {
                duration: 7200,
                vehicle_count: 1500,
                intersections: 25,
                peak_hour: true,
                weather: "clear",
                accident_rate: 0.015,
                traffic_density: "high",
                visibility: "good",
                road_condition: "good"
            },
            coastal: {
                duration: 10800,
                vehicle_count: 800,
                intersections: 15,
                peak_hour: false,
                weather: "sunny",
                accident_rate: 0.01,
                tourist_ratio: 0.4,
                traffic_density: "medium",
                visibility: "excellent",
                road_condition: "good"
            },
            rainy: {
                duration: 5400,
                vehicle_count: 600,
                intersections: 18,
                peak_hour: true,
                weather: "rain",
                accident_rate: 0.02,
                traffic_density: "medium",
                visibility: "low",
                road_condition: "wet"
            }
        };
        
        if (templates[template]) {
            const textarea = document.getElementById('parametersInput');
            textarea.value = JSON.stringify(templates[template], null, 2);
            
            // Update quick controls
            document.getElementById('durationInput').value = templates[template].duration;
            document.getElementById('vehicleCountInput').value = templates[template].vehicle_count;
            document.getElementById('intersectionsInput').value = templates[template].intersections;
            document.getElementById('peakHourSwitch').checked = templates[template].peak_hour;
            
            // Update scenario type based on template
            const scenarioTypeSelect = document.querySelector('select[name="scenario_type"]');
            if (template === 'nairobi') {
                scenarioTypeSelect.value = 'nairobi_peak';
                document.getElementById('timePeriod').value = 'peak';
            } else if (template === 'coastal') {
                scenarioTypeSelect.value = 'mombasa_coastal';
                document.getElementById('timePeriod').value = 'weekend';
            } else if (template === 'rainy') {
                scenarioTypeSelect.value = 'nakuru_central';
                document.getElementById('timePeriod').value = 'peak';
            }
            
            showAlert(`${template.charAt(0).toUpperCase() + template.slice(1)} template loaded!`, 'success');
        }
    }
    
    function loadExample(type) {
        loadTemplate(type);
    }
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container.py-4');
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // Form validation
    document.getElementById('scenarioForm').addEventListener('submit', function(e) {
        const name = document.querySelector('input[name="name"]').value;
        const scenarioType = document.querySelector('select[name="scenario_type"]').value;
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        
        if (!name || !scenarioType) {
            e.preventDefault();
            showAlert('Please fill in all required fields!', 'warning');
            return;
        }
        
        if (!validateJSON()) {
            e.preventDefault();
            return;
        }
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Scenario...';
        submitBtn.disabled = true;
        
        // Allow form submission
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 2000);
    });

    // Auto-update parameters when scenario type changes
    document.querySelector('select[name="scenario_type"]').addEventListener('change', function() {
        updateParameters();
    });

    // Auto-update parameters when time period changes
    document.getElementById('timePeriod').addEventListener('change', function() {
        updateParameters();
    });

    // Auto-update parameters when research priority changes
    document.getElementById('researchPriority').addEventListener('change', function() {
        updateParameters();
    });
</script>

<style>
    /* Custom Styles for Scenario Creation */
    .bg-university {
        background: linear-gradient(135deg, #0a2e5c 0%, #1a5fb4 100%);
    }
    
    .bg-research-footer {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    }
    
    .research-logo, .student-logo {
        background: rgba(255, 255, 255, 0.2);
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }
    
    .scenario-creation-card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    .scenario-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .form-section {
        padding: 20px;
        background: #f8fafc;
        border-radius: 10px;
        margin-bottom: 20px;
        border-left: 4px solid #3b82f6;
    }
    
    .section-title {
        color: #1e293b;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .scenario-type-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%233b82f6' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
        background-size: 16px 12px;
    }
    
    .parameter-quick {
        background: white;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        height: 100%;
    }
    
    .json-editor {
        background: white;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
    }
    
    .json-textarea {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        resize: vertical;
    }
    
    .json-tools .btn {
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .guidelines-card, .examples-card, .actions-card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .guidelines-card:hover, .examples-card:hover, .actions-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .guideline-item {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        padding: 10px;
        background: #f8fafc;
        border-radius: 8px;
    }
    
    .guideline-icon {
        background: #3b82f6;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .guideline-content h6 {
        color: #1e293b;
        margin-bottom: 5px;
    }
    
    .example-scenario {
        padding: 15px;
        background: #f8fafc;
        border-radius: 10px;
        border-left: 4px solid #10b981;
        margin-bottom: 15px;
    }
    
    .example-scenario:nth-child(2) {
        border-left-color: #3b82f6;
    }
    
    .example-scenario:nth-child(3) {
        border-left-color: #f59e0b;
    }
    
    .json-example {
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        max-height: 150px;
        overflow-y: auto;
    }
    
    .actions-card .btn {
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .actions-card .btn:hover {
        transform: translateY(-2px);
    }
    
    .form-check-input:checked {
        background-color: #10b981;
        border-color: #10b981;
    }
    
    .form-switch .form-check-input {
        width: 3em;
        height: 1.5em;
    }
    
    body {
        background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
        min-height: 100vh;
        font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    }
    
    h1, h2, h3, h4, h5, h6 {
        font-weight: 700;
        color: #1e293b;
    }
    
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        padding: 10px 15px;
        font-size: 1rem;
    }
    
    .form-control-lg {
        font-size: 1.1rem;
        padding: 12px 16px;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    textarea.form-control {
        min-height: 120px;
        resize: vertical;
    }
    
    .btn-lg {
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
    }
    
    .input-group-text {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        color: #64748b;
    }
    
    .input-group .form-control:focus {
        z-index: 2;
    }
    
    /* Required field indicator */
    .form-label[for*="name"]::after,
    .form-label[for*="scenario_type"]::after {
        content: " *";
        color: #dc3545;
    }
</style>

<!-- Inter Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Animation -->
<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .scenario-creation-card {
        animation: fadeIn 0.6s ease-out;
    }
    
    .guidelines-card {
        animation: fadeIn 0.6s ease-out 0.2s both;
    }
    
    .examples-card {
        animation: fadeIn 0.6s ease-out 0.3s both;
    }
    
    .actions-card {
        animation: fadeIn 0.6s ease-out 0.4s both;
    }
    
    .alert {
        animation: slideInDown 0.3s ease-out;
    }
    
    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}